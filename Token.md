#Описание api запросов для работы рекурентных платежей через систему Payin-payout
- [Форма создания токена](#Форма-создания-токена)
	- [Ответ системы при создании токена](#Ответ-системы-при-создании-токена)
- [Проверка источника данных](#Проверка-источника-данных)
	- [При создании токена](#При-создании-токена)
- [Пример запроса при создании токена](#Пример-запроса-при-создании-токена)
- [Пример ответа при создании токена](#Пример-ответа-при-создании-токена)
	- [Успешное создание](#Успешное-создание)
	- [При создании возникла ошибка](#При-создании-возникла-ошибка)
- [Список ответов при ошибке создания токена](#Список-ответов-при-ошибке-создания-токена)

### Форма создания токена
Эта форма создает токен для рекурентных платежей, curl запрос отправляется с веб-сайта продавца в систему Payin-payout. <br /> 
Она должна иметь следующие атрибуты и поля: <br />
<b>Action</b> — https://lk.payin-payout.net/api/rpay/token<br />
<b>Method</b> - POST<br />
<b>Fields</b> - поля, передаваемые в форме, описаны в таблице ниже:<br />

Название поля | Обязательное | Тип поля | Описание
:--- | :---: |:---:|:---:|:---:
agentId |да| Целое число, от 1 до 999999 | Идентификатор агента (сайта) продавца, на который покупатель должен совершить платеж.
orderId | да | Строка до 50 символов | В этом поле продавец задает уникальный номер оплаченного заказа (счета) в соответствии со своей системой учета.
agentTime | да | Строка в формате «HH:mm:SS dd.MM.yyyy»| Дата создания платежа на стороне агента
sign | да |Строка | Контрольная подпись оповещения осоздании платежа, которая используется для проверки однозначной идентификации отправителя.

<b>ВАЖНО</b> - перед отправкой запроса необходимо убедиться:<br />

* У магазина должен быть включен способ оплаты через рекурентные платежи.
* Указываемый платеж был успешно оплачен, через Пластиковые карты
* Создать токен можно только для платежей, которые были оплачены в течении 36000 сек.

#### Ответ системы при создании токена
Ответ на запрос создания токена приходит в формате JSON.<br />
Поля передаваемые в ответе запроса, описаны в таблице ниже:<br />

Название поля | Обязательное | Тип поля | Описание
:--- | :---: |:---:|:---:|:---:
status |да| true или false | В случае успешного создания токена true, при ошибке создания false.
result | да | Строка до 100 символов | Если status=true возвращает токен. Иначе [описание ошибки](#Список-ответов-при-ошибке-создания-токена).
### Проверка источника данных
#### При создании токена
При создании токена для рекурентных платежей, продавец передает системе Payin-payout реквизиты платежа и контрольную подпись, позволяющую однозначно идентифицировать
агента.<br/>
При формировании контрольной подписи, продавец "склеивает" значения полей разделяя их символом “#”, в одну строку в следующем порядке:

1. Идентификатор агента (продавца) (agentId);
2. Уникальный номер заказа (счета) (orderId)
3. Дата создания платежа (agentTime)

Пример :
 ````
MD5(8686#87876#13:12:03 10.01.2010#MD5(secret))
````
**secret** — секретная фраза агента, сохраняется через личный кабинет агента MD5 формируется последовательность из 32-х шестнадцатеричных цифр в соответствии с широко распространенным алгоритмом Message Digest 5 (MD5). <br/>

### Пример запроса при создании токена

````
curl  https://lk.payin-payout.net/api/rpay/token --data 'agentId=...&orderId=...&agentTime=....&sign=a9fbcfad6....4fb13cdb0'

````

### Пример ответа при создании токена
#### Успешное создание

````
{"status":true,"result":"5syp...........eu70mb"}
````

#### При создании возникла ошибка

````
{"status":false,"result":"Ошибка, плохой запрос. Платеж устарел для создания токена."}
````

### Список ответов при ошибке создания токена

* Неверная сигнатура.
* Платеж не найден.
* Платеж не оплачен.
* Получение токена невозможно! Платеж оплачен не Пластиковой картой.
* Проблемма с платежом. Получение токена невозможно.
* У магазина отключены рекурентные платежи.
* Ошибка, плохой запрос. Платеж устарел для создания токена.
* Ошибка, плохой запрос. Для уточнения обратитесь в техподдержку.
* Ошибка при создании токена. Обратитесь в техподдержку, если ошибка будет повторяться.
* Общая ошибка системы
