# Описание api запросов для работы рекуррентных платежей через систему Payin-payout
- [Введение](#Введение)
- [Форма создания токена](#Форма-создания-токена)
	- [Ответ системы при создании токена](#Ответ-системы-при-создании-токена)
- [Форма оплаты платежа токеном](#Форма-оплаты-платежа-токеном)
    - [Ответ системы при оплате платежа токеном](#Ответ-системы-при-оплате-платежа-токеном)
- [Проверка источника данных](#Проверка-источника-данных)
	- [При создании токена](#При-создании-токена)
    - [При оплате платежа токеном](#При-оплате-платежа-токеном)	
- [Пример запроса при создании токена](#Пример-запроса-при-создании-токена)
- [Пример ответа при создании токена](#Пример-ответа-при-создании-токена)
	- [Успешное создание](#Успешное-создание)
	- [При создании возникла ошибка](#При-создании-возникла-ошибка)
- [Список ответов при ошибке создания токена](#Список-ответов-при-ошибке-создания-токена)
- [Пример запроса при оплате платежа токеном](#Пример-запроса-при-оплате-платежа-токеном)
- [Пример ответа при оплате платежа токеном](#Пример-ответа-при-оплате-платежа-токеном)
    - [Успешная оплата](#Успешная-оплата)
    - [Успешная оплата для 3DS карт](#Успешная-оплата-для-3ds-карт)
    - [При оплате возникла ошибка](#При-оплате-возникла-ошибка)
- [Список ответов при ошибке оплаты платежа](#Список-ответов-при-ошибке-оплаты-платежа)

### Введение
В системе Payin-payout есть возможность совершать рекуррентные платежи. Это платежи, по которым можно списать средства с карты без подтверждения клиента, на основе договорённости - например "автоплатеж" или оплата периодичной подписки, при которой средства снимаются раз в месяц. Чтобы воспользоваться такой услугой, клиент должен сделать один "полноценный" платеж со вводом всех карточных данных.

Чтобы мерчант мог воспользоваться такой услугой и принимать рекуррентные платежи - он должен предварительно настроить свой магазин, включив в разделе доступных сервисов, возможность совершать рекуррентные платежи.

Для совершения рекуррентных платежей необходимо:

1. Совершить хотя бы один успешный платеж через Пластиковые карты.
2. [Создать токен на успешный платеж.](#Форма-создания-токена)
3. [Использовать токен для совершения новых платежей через Пластиковые карты.](README.md/#Форма-регистрации-платежа)

### Форма создания токена
Эта форма создает токен для рекуррентных платежей, curl запрос отправляется с веб-сайта продавца в систему Payin-payout. <br /> 
Она должна иметь следующие атрибуты и поля: <br />
<b>Action</b> — https://lk.payin-payout.net/api/rpay/token<br />
<b>Method</b> - POST<br />
<b>Fields</b> - поля, передаваемые в форме, описаны в таблице ниже:<br />

Название поля | Обязательное | Тип поля | Описание
:--- | :---: |:---:|:---:|
agentId |да| Целое число, от 1 до 999999 | Идентификатор агента (сайта) продавца, на который покупатель должен совершить платеж.
orderId | да | Строка до 50 символов | В этом поле продавец задает уникальный номер оплаченного заказа (счета) в соответствии со своей системой учета.
agentTime | да | Строка в формате «HH:mm:SS dd.MM.yyyy»| Дата создания платежа на стороне агента
sign | да |Строка | Контрольная подпись оповещения осоздании платежа, которая используется для проверки однозначной идентификации отправителя.

<b>ВАЖНО</b> - перед отправкой запроса необходимо убедиться:<br />

* У магазина должен быть включен способ оплаты через рекуррентные платежи.
* Указываемый платеж был успешно оплачен, через Пластиковые карты
* Создать токен можно только для платежей, которые были оплачены в течении 36000 сек.
* Срок жизни токена 1 год.

#### Ответ системы при создании токена
Ответ на запрос создания токена приходит в формате JSON.<br />
Поля передаваемые в ответе запроса, описаны в таблице ниже:<br />

Название поля | Обязательное | Тип поля | Описание
:--- | :---: |:---:|:---:
status |да| true или false | В случае успешного создания токена true, при ошибке создания false.
result | да | Строка до 100 символов | Если status=true возвращает токен. Иначе [описание ошибки](#Список-ответов-при-ошибке-создания-токена).

### Форма оплаты платежа токеном
Эта форма работает по аналогии с [формой регистрации платежа](README.md/#Форма-регистрации-платежа) с использованием токена, curl запрос отправляется с веб-сайта продавца в систему Payin-payout. <br /> 
Она должна иметь следующие атрибуты и поля: <br />
<b>Action</b> — https://lk.payin-payout.net/api/rpay/pay<br />
<b>Method</b> - POST<br />
<b>Fields</b> - поля, передаваемые в форме, описаны в таблице ниже:<br />

Название поля | Обязательное | Тип поля | Описание
:--- | :---: |:---:|:---:
agentId |да| Целое число, от 1 до 999999 | Идентификатор агента (сайта) продавца, на который покупатель должен совершить платеж.
orderId | да | Строка до 50 символов | В этом поле продавец задает уникальный номер заказа (счета) в соответствии со своей системой учета.
agentName |да| Строка |Торговое название агента,выводится пользователю
userName |нет| Строка | Имя (и фамилия) покупателя. Будет показано в счете в качестве покупателя.
amount |да| Дробное число,больше нуля, дробная часть отделяется точкой, два знака после точки.| Сумма платежа, которую продавец желает получить от покупателя.
goods | да | Строка |Название товара (или счета), которые оплачивает клиент
currency |нет | Строка, 3 символа | Обозначение валюты платежа. По умолчанию - RUR. (подробнее см. [Приложение №2](README.md/#Приложение-№2))
email |да |Строка до 50 символов |Адрес электронной почты покупателя
phone | да | 11 или более цифр, начиная с + | Телефон покупателя в международном формате. Например, для России: +79161234567
preference | да |Целое число |Способ оплаты: Пластиковые карты, который будет выбран при оплате за товар. см. [Приложение №1](README.md/#Приложение-№1). 
agentTime | да | Строка в формате «HH:mm:SS dd.MM.yyyy»| Дата создания платежа на стороне агента
limitTime  |нет  |Строка в формате «HH:mm:SS dd.MM.yyyy» | Дата, по истечении которой, заказ считается просроченным. По умолчанию 24 часа
successUrl |нет | Строка длиной до 1024 символов| Адрес на который будет перенаправлен пользователь в случае успешной оплаты
failUrl | нет | Строка длиной до 1024 символов | Адрес на который будет перенаправлен пользователь в случае отмены оплаты
shop_url | нет | Строка длиной до 1024 символов | Адрес на который будет перенаправлен пользователь в случае нажатии им на ссылку "Вернуться в магазин"
addInfo_N | нет | Строка длиной до 1024 символов | Все поля формы, имеющие в названии префикса "addInfo_N"(где N порядковый номер),обрабатываются системой Payin-payout автоматически и передаются на сайт продавца. (Кодировка UTF-8)
token | да | Строка | Токен для соверешения рекуррентых платежей. [Создание токена](#Форма-создания-токена)
sign | да | Строка | Контрольная подпись оповещения осоздании платежа, которая используется для проверки однозначной идентификации отправителя.

<b>ВАЖНО</b> - перед отправкой запроса необходимо убедиться:<br />

* У магазина должен быть включен способ оплаты через рекуррентные платежи.

#### Ответ системы при оплате платежа токеном
Ответ на запрос оплаты платежа токеном приходит в формате JSON.<br />
Поля передаваемые в ответе запроса, описаны в таблице ниже:<br />

Название поля | Обязательное | Тип поля | Описание
:--- | :---: |:---:|:---:|
status |да| true или false | В случае успешного выполнения true, при ошибке false.
result | да | Строка до 100 символов | Если status=true возвращает "Запрос успешно отправлен.", если ответ: "Для завершения транзакции необходимо перейти по адресу.", то карта защищенная протоколом 3D Secure. Иначе [описание ошибки](#Список-ответов-при-ошибке-оплаты-платежа).
url | нет | Строка до 200 символов | для карт, защищенных протоколом 3D Secure необходимо завершение транзакции путем перехода по этому адресу. Для ввода пароля.

### Проверка источника данных
#### При создании токена
При создании токена для рекуррентных платежей, продавец передает системе Payin-payout реквизиты платежа и контрольную подпись, позволяющую однозначно идентифицировать
агента.<br/>
При формировании контрольной подписи, продавец "склеивает" значения полей разделяя их символом “#”, в одну строку в следующем порядке:

1. Идентификатор агента (продавца) (agentId);
2. Уникальный номер заказа (счета) (orderId)
3. Дата создания платежа (agentTime)

Пример :
 ````
MD5(8686#87876#13:12:03 10.01.2010#MD5(secret))
````

#### При оплате платежа токеном
По аналогии [при формированием счета](README.md/#При-формировании-счета) с токеном, продавец передает системе Payin-payout реквизиты платежа и контрольную подпись, позволяющую однозначно идентифицировать
агента.<br/>
При формировании контрольной подписи, продавец "склеивает" значения полей разделяя их символом “#”, в одну строку в следующем порядке:

1. Идентификатор агента (продавца) (agentId);
2. Уникальный номер заказа (счета) (orderId)
3. Дата создания платежа (agentTime)
4. Сумма платежа (amount)
5. Телефон покупателя (phone)
6. Токен (token) [Создание токена](#Форма-создания-токена)


Пример с токеном :
 ````
MD5(8686#87876#13:12:03 10.01.2010#166.70#79090000001#хххххххххххххххххххххххххххххххх#MD5(secret))
````
**secret** — секретная фраза агента, сохраняется через личный кабинет агента MD5 формируется последовательность из 32-х шестнадцатеричных цифр в соответствии с широко распространенным алгоритмом Message Digest 5 (MD5). <br/>

### Пример запроса при создании токена

````
curl  https://lk.payin-payout.net/api/rpay/token --data 'agentId=...&orderId=...&agentTime=....&sign=a9fbcfad6....4fb13cdb0'

````

### Пример ответа при создании токена
#### Успешное создание

````
{"status":true,"result":"5syp...........eu70mb"}
````

#### При создании возникла ошибка

````
{"status":false,"result":"Ошибка, плохой запрос. Платеж устарел для создания токена."}
````

### Список ответов при ошибке создания токена

* Неверная сигнатура.
* Неверный ip: .......
* Платеж не найден.
* Платеж не оплачен.
* Получение токена невозможно! Платеж оплачен не Пластиковой картой.
* Проблемма с платежом. Получение токена невозможно.
* У магазина отключены рекуррентные платежи.
* Ошибка, плохой запрос. Платеж устарел для создания токена.
* Ошибка, плохой запрос. Для уточнения обратитесь в техподдержку.
* Ошибка при создании токена. Обратитесь в техподдержку, если ошибка будет повторяться.
* Общая ошибка системы

### Пример запроса при оплате платежа токеном

````
curl  https://lk.payin-payout.net/api/rpay/token --data 'agentId=8686&orderId=87876&agentName=Superstore&amount=166.70&goods=Notebook&email=user@example.ru&phone=+79090000001&agentTime="20:35:67 01.01.2010"&token=ds.......kf&currency=RUR&preference=125&sign=980......84f'


````

### Пример ответа при оплате платежа токеном
#### Успешная оплата

````
{"status":true,"result":"Запрос успешно отправлен."}
````

#### Успешная оплата для 3DS карт

````
{"status":true,"result":"Для завершения транзакции необходимо перейти по адресу.","url":"https://Адрес-для-завершения-транзакции"}
````

#### При оплате возникла ошибка

````
{"status":false,"result":"Возникли ошибки, обратитесь в техподдержку"}
````

### Список ответов при ошибке оплаты платежа

* Неверный формат идентификатора агента
* Неверный ip магазина: .........
* Запрещенны рекурентные платежи
* Неверная сигнатура
* Неверный формат идентификатора агента
* Неверный формат суммы
* Неверный формат валюты
* Неверный формат телефона покупателя
* Неверный формат способа оплаты
* Неверный формат токена
* Неверный текущий статус платежа
* Возникли ошибки, обратитесь в техподдержку
* Общая ошибка системы
